{
   "rows": [
      {
         "panels": [
            {
               "alert": "KubeAPIErrorRatioHigh",
               "alert_expr": "sum by (instance)(\n  rate(apiserver_request_count{verb!~\"(CONNECT|WATCH)\", code=~\"5..\"}[5m])\n) /\nsum by (instance)(\n  rate(apiserver_request_count[5m])\n) > 0.01\n",
               "annotations": {
                  "description": "Issue: Kube API Error ratio on {{ $labels.instance }} is above 0.01: {{ $value }}\nPlaybook: https://engineering-handbook.nami.run/sre/runbooks/kubeapi#KubeAPIErrorRatioHigh\n",
                  "summary": "Kube API 500s ratio is High"
               },
               "formula": "sum by (verb, code)(\n  rate(apiserver_request_count{verb!~\"$verb_excl\", code=~\"5..\"}[5m])\n) / ignoring(code) group_left\nsum by (verb)(\n  rate(apiserver_request_count[5m])\n)\n",
               "legend": "{{ verb }} - {{ code }}",
               "threshold": 0.01,
               "title": "API Error ratio 500s/total (except $verb_excl)"
            },
            {
               "alert": "KubeAPILatencyHigh",
               "alert_expr": "histogram_quantile (\n  0.90,\n  sum by (le, instance)(\n    rate(apiserver_request_latencies_bucket{verb!~\"(CONNECT|WATCH)\"}[5m])\n  )\n) / 1e3 > 200\n",
               "annotations": {
                  "description": "Issue: Kube API Latency on {{ $labels.instance }} is above 200: {{ $value }}\nPlaybook: https://engineering-handbook.nami.run/sre/runbooks/kubeapi#KubeAPILatencyHigh\n",
                  "summary": "Kube API Latency is High"
               },
               "formula": "histogram_quantile (\n  0.$api_percentile,\n  sum by (le, verb)(\n    rate(apiserver_request_latencies_bucket{verb!~\"$verb_excl\"}[5m])\n  )\n) / 1e3 > 0\n",
               "legend": "{{ verb }}",
               "threshold": 200,
               "title": "API $api_percentile-th latency[ms] by verb (except $verb_excl)"
            }
         ],
         "title": "Kube API"
      },
      {
         "panels": [
            {
               "alert": "KubeControllerWorkDurationHigh",
               "alert_expr": "sum by (instance)(\n  APIServiceRegistrationController_work_duration{quantile=\"0.9\"}\n) > 100\n",
               "annotations": {
                  "description": "Issue: Kube Control Manager on {{ $labels.instance }} work duration is above 100: {{ $value }}\nPlaybook: https://engineering-handbook.nami.run/sre/runbooks/kubeapi#KubeControllerWorkDurationHigh\n",
                  "summary": "Kube Control Manager workqueue processing is slow"
               },
               "formula": "sum by (instance)(\n  APIServiceRegistrationController_work_duration{quantile=\"0.9\"}\n)\n",
               "legend": "{{ instance }}",
               "threshold": 100,
               "title": "Kube Control Manager work duration"
            }
         ],
         "title": "Kube Control Manager"
      },
      {
         "panels": [
            {
               "alert": "KubeEtcdLatencyHigh",
               "alert_expr": "max by (instance)(\n  rate(etcd_request_latencies_summary{job=\"kubernetes_apiservers\",quantile=\"0.9\"}[5m]) < Inf\n)/ 1e3 > 20\n",
               "annotations": {
                  "description": "Issue: Kube Etcd latency on {{ $labels.instance }} above 20: {{ $value }}\nPlaybook: https://engineering-handbook.nami.run/sre/runbooks/kubeapi#KubeEtcdLatencyHigh\n",
                  "summary": "Etcd Latency is High"
               },
               "formula": "max by (operation, instance)(\n  rate(etcd_request_latencies_summary{job=\"kubernetes_apiservers\",quantile=\"0.9\"}[5m]) < Inf\n)/ 1e3\n",
               "legend": "{{ instance }} - {{ operation }}",
               "threshold": 20,
               "title": "etcd 90th latency[ms] by (operation, instance)"
            }
         ],
         "title": "Kube Etcd"
      }
   ],
   "templates_custom": {
      "api_percentile": {
         "default": "90",
         "hide": "",
         "values": "50, 90, 99"
      },
      "verb_excl": {
         "default": "(CONNECT|WATCH)",
         "hide": "variable",
         "values": "(CONNECT|WATCH)"
      }
   }
}
